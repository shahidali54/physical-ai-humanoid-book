# Humanoid Controller Configuration
# Configuration for controllers specifically adapted for humanoid robot navigation

controller_server:
  ros__parameters:
    use_sim_time: True
    controller_frequency: 20.0
    min_x_velocity_threshold: 0.001
    min_y_velocity_threshold: 0.5
    min_theta_velocity_threshold: 0.001
    failure_tolerance: 0.3
    progress_checker_plugin: "progress_checker"
    goal_checker_plugin: "goal_checker"
    controller_plugins: ["HumanoidMPPIC", "HumanoidDWB"]

    # Humanoid-specific MPPI Controller
    HumanoidMPPIC:
      plugin: "nav2_mppi_controller::MPPIController"
      time_horizon: 1.5  # Extended for humanoid stability
      frequency: 20.0
      velocity_samples: 20
      model_dt: 0.05
      batch_size: 2000
      ctrl_freq: 20.0
      aux_variance: 0.5
      w_collision: 100.0
      w_cost: 1.0
      w_smoothness: 1.0
      w_obstacles: 50.0
      w_steering_angle: 10.0
      w_throughput: 1.0
      w_goal_distance: 50.0
      w_goal_angle: 20.0
      w_velocity: 1.0
      w_footstep: 50.0  # Humanoid-specific weight for footstep planning
      max_linear_speed: 0.4  # Reduced for humanoid stability
      min_linear_speed: 0.05
      max_angular_speed: 0.3  # Reduced for humanoid stability
      min_angular_speed: 0.05
      max_acceleration: 0.3  # Reduced for humanoid stability
      max_deceleration: 0.3  # Reduced for humanoid stability

    # Humanoid-specific DWB Controller
    HumanoidDWB:
      plugin: "dwb_core::DWBLocalPlanner"
      debug_trajectory_details: True
      min_vel_x: 0.05
      min_vel_y: 0.0
      max_vel_x: 0.4  # Reduced for humanoid stability
      max_vel_y: 0.0
      max_vel_theta: 0.3  # Reduced for humanoid stability
      min_speed_xy: 0.05
      max_speed_xy: 0.4
      min_speed_theta: 0.05
      acc_lim_x: 0.3  # Reduced for humanoid stability
      acc_lim_y: 0.0
      acc_lim_theta: 0.3  # Reduced for humanoid stability
      decel_lim_x: -0.3
      decel_lim_y: 0.0
      decel_lim_theta: -0.3
      vx_samples: 20
      vy_samples: 0
      vtheta_samples: 40
      sim_time: 1.5  # Extended for humanoid stability
      linear_granularity: 0.05
      angular_granularity: 0.1
      transform_tolerance: 0.2
      xy_goal_tolerance: 0.25  # Humanoid-specific tolerance
      yaw_goal_tolerance: 0.25
      stateful: True
      critics: ["RotateToGoal", "Oscillation", "BaseObstacle", "GoalAlign", "PathAlign", "HumanoidBalance"]
      HumanoidBalance.scale: 5.0  # Humanoid-specific critic for balance
      PathAlign.scale: 32.0
      GoalAlign.scale: 24.0
      Obstacle.scale: 0.02
      Obstacle.max_scaling_factor: 2.0
      Oscillation.scale: 1.0
      Oscillation.oscillation_reset_angle: 0.2
      RotateToGoal.scale: 32.0
      RotateToGoal.slowing_factor: 5.0
      RotateToGoal.lookahead_time: -1.0

    progress_checker:
      plugin: "nav2_controller::SimpleProgressChecker"
      required_movement_radius: 0.5  # Humanoid-specific
      movement_time_allowance: 15.0  # Extended for humanoid

    goal_checker:
      plugin: "nav2_controller::SimpleGoalChecker"
      xy_goal_tolerance: 0.3  # Humanoid-specific tolerance
      yaw_goal_tolerance: 0.3  # Humanoid-specific tolerance
      stateful: True

# Humanoid-specific behavior tree plugins
bt_navigator:
  ros__parameters:
    use_sim_time: True
    global_frame: "map"
    robot_base_frame: "base_footprint"
    odom_topic: "/odom"
    default_bt_xml_filename: "humanoid_navigate_w_replanning_and_recovery.xml"
    plugin_lib_names:
      - "humanoid_bt_nodes/NavigateToPose"
      - "humanoid_bt_nodes/NavigateThroughPoses"
      - "humanoid_bt_nodes/FollowPath"
      - "humanoid_bt_nodes/ComputePathToPose"
      - "humanoid_bt_nodes/ComputePathThroughPoses"
      - "humanoid_bt_nodes/BackUp"
      - "humanoid_bt_nodes/Spin"
      - "humanoid_bt_nodes/Wait"
      - "humanoid_bt_nodes/HumanoidRecoveryNode"
      - "humanoid_bt_nodes/HumanoidPipelineSequence"
      - "humanoid_bt_nodes/HumanoidRecoveryNode"
      - "humanoid_bt_nodes/PipelineSequence"
      - "humanoid_bt_nodes/TransformAvailableCondition"
      - "humanoid_bt_nodes/SingleTrigger"
      - "humanoid_bt_nodes/MultiThreadedSequence"
      - "humanoid_bt_nodes/NavigationMode"

# Footstep planner configuration (simulated)
footstep_planner:
  ros__parameters:
    use_sim_time: True
    step_length: 0.3  # meters
    step_width: 0.2   # meters
    step_height: 0.15 # meters
    max_step_inflation: 0.1  # meters
    enable_balance_checking: True
    balance_threshold: 0.1   # meters from center of mass
    enable_terrain_adaptation: True
    max_step_up_height: 0.15 # meters
    max_step_down_height: 0.2 # meters
    foot_separation: 0.2     # distance between feet
    nominal_step_duration: 1.0 # seconds